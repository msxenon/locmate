# Installation
# dart pub global activate melos
name: monaweb
repository: https://github.com/msxenon/locmate
sdkPath: .fvm/flutter_sdk

packages:
  - "packages/*"
  - "example"
command:
  version:
    # Generate commit links in package changelogs.
    linkToCommits: true
    # # Only allow versioning to happen on main branch.
    # branch: master
    # Additionally build a changelog at the root of the workspace.
    workspaceChangelog: true

  bootstrap:
    # It seems so that running "pub get" in parallel has some issues (like
    # https://github.com/dart-lang/pub/issues/3404). Disabling this feature
    # makes the CI much more stable.
    runPubGetInParallel: false

scripts:
  gen:
    run: melos exec --depends-on="build_runner" dart run build_runner build --delete-conflicting-outputs
  tests:
    run: melos exec --fail-fast --depends-on="flutter_test" -- flutter test

  build:
    run: sh scripts/build_web_and_move.sh

  locmate:
    run: cd example && dart pub run locmate

  buildLocmate:
    run: melos run build && melos run locmate

  kClean:
    run: melos exec flutter clean

  patrolTest:
    run: sh packages/locmate_web/patrol_test/run.sh

  healthChecks:
    run: |
      melos exec dart format --set-exit-if-changed
      melos exec dart analyze --fatal-infos --fatal-warnings
      melos run gen
      melos exec pubghost -d
      melos exec pubghost -c
      melos run tests
      melos run patrolTest

  prePublishChecks:
    run: |
      melos run healthChecks
      melos run build
      dart run scripts/check_web_versions.dart
